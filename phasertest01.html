<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Firewall Penitentiary</title>
    <script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
    body {
        background-color: darkblue;
        float: left;
        box-sizing: border-box;
    }
    /* This is the element to modify to style the game window */

    canvas {
        border: lightblue 2px solid;
        margin: 10px;
    }

    #mainScreen {
        width: 800px;
        height: 600px;
    }

    #chatWindow {
        background-color: lightblue;
        width: 800;
        height: 100px;
    }
    </style>
</head>

<body>
    <div></div>
    <div id="#mainScreen">
    </div>
    <div id="#chatWindow"></div>
    <script type="text/javascript">
    /* $(document).ready (function () {

                                                                                                                                                                                                                                                                                                                                                                                                                    });*/

    var game = new Phaser.Game(800, 600, Phaser.AUTO, '#mainScreen', {
        preload: preload,
        create: create,
        update: update
    });

    var music = new Audio('assets/audio/Urban-Jungle-2061_Looping.mp3');
    var explosion = new Audio('assets/audio/explosion.mp3');

    var player, playerBullets, playerShield, playerGun, stars, gun, fireButton, newCursor;
    console.log(game);


    function preload() {

        game.load.image('map01', 'assets/map01small.jpg');
        game.load.image('star', 'assets/star.png');
        game.load.spritesheet('playerBullet', 'assets/playerBullet.png', 10, 10);
        game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
        game.load.spritesheet('shield_blue', 'assets/shield_blue.png', 32, 10);
        game.load.spritesheet('gun_basic', 'assets/gun_basic.png', 8, 15);
        game.load.spritesheet('prisoner_blue', 'assets/prisoner_blue.png', 40, 40);
        game.load.spritesheet('prisoner_red', 'assets/prisoner_red.png', 40, 40);
        game.load.spritesheet('prisoner_green', 'assets/prisoner_green.png', 40, 40);
        game.load.spritesheet('prisoner_yellow', 'assets/prisoner_yellow.png', 40, 40);
        // game.load.audio('background-music', ['assets/audio/Urban-Jungle-2061_Looping'])


    }


    function create() {

        music.play();

        /*Create map & terrain features*/
        game.add.sprite(0, 0, 'map01');


        //Adds a group called stars and then randomly adds 10 stars scattered over the map
        stars = game.add.group();
        for (i = 0; i < 10; i++) {
            var xLoc = Math.floor(Math.random() * 790);
            var yLoc = Math.floor(Math.random() * 590);
            stars.create(xLoc, yLoc, 'star');
        };
        //Enable physics for the stars group
        game.physics.arcade.enable(stars);
        //Iterates over each member of the stars group and stops them from leaving map.
        stars.forEachAlive(function(star) {
            star.body.collideWorldBounds = true;
            star.body.immovable = true;
        });

        //Creates a group called playerBullets and randomly adds 10 of them to the map
        playerBullets = game.add.group();
        for (i = 0; i < 10; i++) {
            var xLoc = Math.floor(Math.random() * 790);
            var yLoc = Math.floor(Math.random() * 590);
            playerBullets.create(xLoc, yLoc, 'playerBullet');
        }
        //Enable physics for the playerBullets group
        game.physics.arcade.enable(playerBullets);
        //Iterates over each member of the playerBullets group and stops them from leaving map.  Also adds bounce and sets center for rotation
        playerBullets.forEachAlive(function(playerBullet) {
            playerBullet.body.collideWorldBounds = true;
            playerBullet.body.bounce.x = 1;
            playerBullet.body.bounce.y = 1;
            playerBullet.anchor.setTo(0.5, 0.5);
        });
        playerBullets.forEachAlive(function(playerBullet) {
            playerBullet.body.velocity.x = (Math.floor(Math.random() * 500) - 250);
            playerBullet.body.velocity.y = (Math.floor(Math.random() * 500) - 250);
        });
        //loads the player into the map
        spawnPlayer();
        // adding weapon and a firebutton and having its movements track player

        gun = game.add.weapon(1, 'playerBullet');
        gun.addBulletAnimation('bulletSpin', [0, 1], 10, true);
        // gun.bulletSpeed(400);
        gun.fireRate = 30;
        gun.trackSprite(player, 14, 0);
        newCursor = this.input.keyboard.createCursorKeys();
        fireButton = this.input.keyboard.addKey(Phaser.KeyCode.SPACEBAR);
    }

    function update() {
        //spin bullets
        playerBullets.forEachAlive(function(playerBullet) {
            playerBullet.angle += 10;
        });

        //Create a collision event - player vs stars
        var starStruck = game.physics.arcade.collide(player, stars);
        var shieldStruck = game.physics.arcade.collide(playerShield, playerBullets);

        //Collision detection for weapons fire
        //vs player
        game.physics.arcade.collide(player, playerBullets, killPlayer, null, this);
        game.physics.arcade.collide(playerShield, playerBullets, deflectBullet, null, this);
        //vs shield
        /* */

        /*Entity Movement*/
        //Iterates over the stars group and moves them randomly, making them buzz like angry wasps
        stars.forEachAlive(function(star) {
            star.body.velocity.x = (Math.floor(Math.random() * 250) - 125);
            star.body.velocity.y = (Math.floor(Math.random() * 250) - 125);
        });

        //  Reset the players velocity, x and y, so they stop when not pressing movement keys
        player.body.velocity.x = 0;
        player.body.velocity.y = 0;

        //Register cursor keys for player movement
        var cursors = game.input.keyboard.createCursorKeys(),
            //Register the other keys.
            keySPACE = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),
            keyA = game.input.keyboard.addKey(Phaser.Keyboard.A),
            keyS = game.input.keyboard.addKey(Phaser.Keyboard.S),
            keyW = game.input.keyboard.addKey(Phaser.Keyboard.W),
            keyD = game.input.keyboard.addKey(Phaser.Keyboard.D),
            //Register mouse for aiming and firing
            mouse = game.input.mousePointer;

        //Stop the following keys from propagating up to the browser - is this necessary?
        game.input.keyboard.addKeyCapture([Phaser.Keyboard.SPACEBAR]);

        /*Movement event handlers. Note: If you don't account for diagonals first, cardinals will override and only move you in one direction, not two.*/
        /* game.debug.body(playerShield);
         game.debug.body(player);*/
        if (keyW.isDown && keyA.isDown || cursors.up.isDown && cursors.left.isDown) {
            //UP LEFT
            player.body.velocity.x = -150;
            player.body.velocity.y = -150;
            player.animations.play('walk');
            playerShield.animations.play('swingShield');
            playerGun.animations.play('swingGun');
        } else if (keyW.isDown && keyD.isDown || cursors.up.isDown && cursors.right.isDown) {
            //UP RIGHT
            player.body.velocity.x = 150;
            player.body.velocity.y = -150;
            player.animations.play('walk');
            playerShield.animations.play('swingShield');
            playerGun.animations.play('swingGun');
        } else if (keyS.isDown && keyA.isDown || cursors.down.isDown && cursors.left.isDown) {
            //DOWN LEFT
            player.body.velocity.x = -150;
            player.body.velocity.y = 150;
            player.animations.play('walk');
            playerShield.animations.play('swing');
            playerGun.animations.play('swingGun');
        } else if (keyS.isDown && keyD.isDown || cursors.down.isDown && cursors.right.isDown) {
            //DOWN RIGHT
            player.body.velocity.x = 150;
            player.body.velocity.y = 150;
            player.animations.play('walk');
            playerShield.animations.play('swingShield');
            playerGun.animations.play('swingGun');
        } else if (keyW.isDown || cursors.up.isDown) {
            //UP

            /*game.physics.arcade.accelerationFromRotation(*/
            player.body.velocity.y = -150;
            player.animations.play('walk');
            playerShield.animations.play('swingShield');
            playerGun.animations.play('swingGun');
            player.angle = 0;
            gun.fireAngle = Phaser.ANGLE_UP;
            gun.trackSprite(player, 15, -19);
            playerShield.body.setSize(32, 15, 0, 0);
            /*       playerShield.angle = 0;*/
        } else if (keyS.isDown || cursors.down.isDown) {
            //DOWN
            player.body.velocity.y = 150;
            player.animations.play('walk');
            playerShield.animations.play('swingShield');
            playerGun.animations.play('swingGun');
            player.angle = 180;
            gun.fireAngle = Phaser.ANGLE_DOWN;
            gun.trackSprite(player, -15, 19);
            playerShield.body.setSize(32, 15, -32, -15);
            /*  playerShield.angle = 180;*/
        } else if (keyA.isDown || cursors.left.isDown) {
            //LEFT
            player.body.velocity.x = -150;
            player.animations.play('walk');
            playerShield.animations.play('swingShield');
            playerGun.animations.play('swingGun');
            player.angle = -90;
            gun.fireAngle = Phaser.ANGLE_LEFT;
            gun.trackSprite(player, -19, -15);
            playerShield.body.setSize(15, 32, 0, -32);
            /*  playerShield.angle = -90;*/
        } else if (keyD.isDown || cursors.right.isDown) {
            //RIGHT
            player.body.velocity.x = 150;
            player.animations.play('walk');
            playerShield.animations.play('swingShield');
            playerGun.animations.play('swingGun');
            player.angle = 90;
            gun.fireAngle = Phaser.ANGLE_RIGHT;
            gun.trackSprite(player, 19, 15);
            playerShield.body.setSize(15, 32, -15, 0);

            /*   playerShield.angle = 90;*/
        } else {
            //Stand still

            player.animations.stop();
            playerShield.animations.stop();
            playerGun.animations.stop();
            /*  player.frame = 4;*/
        }


        //Checks to see if the spacebar is down
        if (fireButton.isDown) {
            gun.fire();
            explosion.play();
        }

        if (mouse.isDown) {
            console.log("Mouse X: " + mouse.x + " Y: " + mouse.y);
        }
    }




    function spawnPlayer() {
        /*Create player and its settings*/
        player = game.add.sprite(400, 300, 'prisoner_blue');
        //Enable physics on the player
        game.physics.arcade.enable(player);
        //
        /*player.body.setSize(30, 30, 5, 0);*/
        player.body.isCircle = true;
        player.body.setCircle(15, 5, 5);
        //Stop player and stars from leaving map.
        player.body.collideWorldBounds = true;
        //Make the player walk
        player.animations.add('walk', [0, 1, 2, 3], 10, true);
        //Set the center of the head as the rotation axis
        player.anchor.setTo(0.5, 0.5);
        console.log(player);
        //Create the player's shield, add animation for walking and make the shield a child of the player
        playerShield = game.add.sprite(-30, -25, 'shield_blue');
        game.physics.arcade.enable(playerShield);
        playerShield.body.immovable = true;
        playerShield.animations.add('swingShield', [0, 1, 2, 3], 10, true);
        player.addChild(playerShield);
        //Create the player's basic weapon, add animation for walking and make it a child of player
        playerGun = game.add.sprite(10, -23, 'gun_basic');
        playerGun.animations.add('swingGun', [0, 1, 2, 3], 10, true);
        playerGun.animations.add('fireGun', [0, 1, 2], 15, false);
        player.addChild(playerGun);
    };

    function respawnPlayer() {
        player.revive();
        player.x = 400, player.y = 300;
    };

    function killPlayer() {
        player.kill();
        setTimeout(respawnPlayer, 5000);
    }

    function deflectBullet() {
        console.log("Deflected by shield");
    };



    /*function deflectBullet(playerShield, playerBullets) {
        playerBullets.velocity.x = playerBullets.velocity.x * -1;
        playerBullets.velocity.y = playerBullets.velocity.y * -1;
        console.log(playerBullets);
    };*/
    </script>
</body>

</html>