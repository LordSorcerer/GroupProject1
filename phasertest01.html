<!doctype html>
<html lang="en">

<head>

	<meta charset="UTF-8" />
	<title>Firewall Penitentiary</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script type="text/javascript" src="js/phaser.min.js"></script>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Audiowide" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/style.css">

</head>

<body>

	<div class="container">

		<div id="#mainScreen"></div>

		<div class="header">
			<h1>Firewall Penitentary</h1>
		</div>

		<table>
			<tr>
				<th><font color="red">Red</font></th>
				<th><font color="yellow">Yellow</font></th> 
				<th><font color="blue">Blue</font></th>
				<th><font color="green">Green</font></th>
			</tr>
			<tr>
				<td>3</td>
				<td>1</td>
				<td>2</td>
				<td>0</td>
			</tr>
		</table>

		<br>

		<div id="chatWindow">
			<p>Chat</p>
		</div>


	</div>

	<script type="text/javascript">


        var game, player, players, playerShields = [], playerBullets, playerShield, playerGun, pillars, gun, fireButton, newCursor, playerBlue, playerRed, playerYellow, playerGreen;

        var game = new Phaser.Game(800, 600, Phaser.AUTO, '#mainScreen', {
        	preload: preload,
        	create: create,
        	update: update
        });

		//Network functionality
		var socket;

		console.log(game);

		function preload() {

			game.load.image('map01', './assets/map01small.jpg');
			game.load.image('pillar', './assets/pillar.png');
			game.load.spritesheet('playerBullet', './assets/playerBullet.png', 10, 10);
			game.load.spritesheet('shield_blue', './assets/shield_blue.png', 32, 10);
			game.load.spritesheet('shield_red', './assets/shield_red.png', 32, 10);
			game.load.spritesheet('shield_yellow', './assets/shield_yellow.png', 32, 10);
			game.load.spritesheet('shield_green', './assets/shield_green.png', 32, 10);
			game.load.spritesheet('prisoner_blue', './assets/prisoner_blue.png', 40, 40);
			game.load.spritesheet('prisoner_red', './assets/prisoner_red.png', 40, 40);
			game.load.spritesheet('prisoner_green', './assets/prisoner_green.png', 40, 40);
			game.load.spritesheet('prisoner_yellow', './assets/prisoner_yellow.png', 40, 40);
			game.load.spritesheet('gun_basic', './assets/gun_basic.png', 8, 15);

		}

		function create() {
			/*Create map & terrain features*/
			game.add.sprite(0, 0, 'map01');

				//Adds a group called pillars and then adds one in front of each player's base
				pillars = game.add.group();
				pillars.create(175, 275, 'pillar');
				pillars.create(575, 275, 'pillar');
				pillars.create(375, 125, 'pillar');
				pillars.create(375, 425, 'pillar');
				//Enable physics for the pillars group
				game.physics.arcade.enable(pillars);
				//Iterates over each member of the pillars group and stops them from leaving map.
				pillars.forEachAlive(function(pillar) {
					pillar.body.collideWorldBounds = true;
					pillar.body.immovable = true;
				});

				//Creates a group called playerBullets and randomly adds 10 of them to the map
				playerBullets = game.add.group();
				for (i = 0; i < 10; i++) {
					var xLoc = Math.floor(Math.random() * 790);
					var yLoc = Math.floor(Math.random() * 590);
					playerBullets.create(xLoc, yLoc, 'playerBullet');
				}
				//Enable physics for the playerBullets group
				game.physics.arcade.enable(playerBullets);
				//Iterates over each member of the playerBullets group and stops them from leaving map.  Also adds bounce and sets center for rotation
				playerBullets.forEachAlive(function(playerBullet) {
					playerBullet.body.collideWorldBounds = true;
					playerBullet.body.bounce.x = 1;
					playerBullet.body.bounce.y = 1;
					playerBullet.anchor.setTo(0.5, 0.5);
					playerBullet.body.velocity.x = (Math.floor(Math.random() * 500) - 250);
					playerBullet.body.velocity.y = (Math.floor(Math.random() * 500) - 250);
				});

				//Create a group for all the players
				players = game.add.group();
				//loads the players onto the map
				playerRed = spawnPlayer("red");
				players.add(playerRed);
				playerYellow = spawnPlayer("yellow");
				players.add(playerYellow);
				playerGreen = spawnPlayer("green");
				players.add(playerGreen);
				playerBlue = spawnPlayer("blue");
				players.add(playerBlue);
				// adding weapon and a firebutton and having its movements track player
				gun = game.add.weapon(1, 'playerBullet');
				// gun.bulletSpeed(400);
				/*     gun.bounce.x = 1;
				gun.bounce.y = 1;*/
				gun.fireRate = 30;
				gun.trackSprite(player, 15, -19);
				newCursor = this.input.keyboard.createCursorKeys();
				fireButton = this.input.keyboard.addKey(Phaser.KeyCode.SPACEBAR);
			}

			function update() {
				//spin bullets
				playerBullets.forEachAlive(function(playerBullet) {
					playerBullet.angle += 10;
				});

				gun.bullets.forEachAlive(function(playerBullet) {
					playerBullet.angle += 10;
				});

				//Create a collision event - player vs pillars
				var pillarStruck = game.physics.arcade.collide(players, pillars);
				var pillarShot = game.physics.arcade.collide(playerBullets, pillars);
				var shieldStruck = game.physics.arcade.collide(playerShields, playerBullets);
				var pillarShot2 = game.physics.arcade.collide(gun.bullets, pillars);
				var shieldStruck2 = game.physics.arcade.collide(playerShields, gun.bullets);

				//Collision detection for weapons fire
				//vs player
				game.physics.arcade.collide(players, playerBullets, killPlayer, null, this);
				game.physics.arcade.collide(players, gun.bullets, killPlayer, null, this);

				//Register cursor keys for player movement
				var cursors = game.input.keyboard.createCursorKeys(),
						//Register the other keys.
						keySPACE = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),
						keyA = game.input.keyboard.addKey(Phaser.Keyboard.A),
						keyS = game.input.keyboard.addKey(Phaser.Keyboard.S),
						keyW = game.input.keyboard.addKey(Phaser.Keyboard.W),
						keyD = game.input.keyboard.addKey(Phaser.Keyboard.D),
						//Register mouse for aiming and firing
						mouse = game.input.mousePointer;

				//Stop the following keys from propagating up to the browser - is this necessary?
				game.input.keyboard.addKeyCapture([Phaser.Keyboard.SPACEBAR]);

				/*Movement event handlers. Note: If you don't account for diagonals first, cardinals will override and only move you in one direction, not two.*/
				player.body.velocity.x = 0;
				player.body.velocity.y = 0;

				game.debug.body(playerShield);
				game.debug.body(player);
				if (keyW.isDown && keyA.isDown || cursors.up.isDown && cursors.left.isDown) {
						//UP LEFT
						socket.emit('move', 7);
					} else if (keyW.isDown && keyD.isDown || cursors.up.isDown && cursors.right.isDown) {
						//UP RIGHT
						socket.emit('move', 1);
					} else if (keyS.isDown && keyA.isDown || cursors.down.isDown && cursors.left.isDown) {
						//DOWN LEFT
						socket.emit('move', 5);
					} else if (keyS.isDown && keyD.isDown || cursors.down.isDown && cursors.right.isDown) {
						//DOWN RIGHT
						socket.emit('move', 3);
					} else if (keyW.isDown || cursors.up.isDown) {
						//UP
						socket.emit('move', 0);
					} else if (keyS.isDown || cursors.down.isDown) {
						//DOWN
						socket.emit('move', 4);
					} else if (keyA.isDown || cursors.left.isDown) {
						//LEFT
						socket.emit('move', 6);
					} else if (keyD.isDown || cursors.right.isDown) {
						//RIGHT
						socket.emit('move', 2);
					} else {
						//Stand still
						//  Reset the players velocity, x and y, so they stop when not pressing movement keys
						player.animations.stop();
						playerShield.animations.stop();
						playerGun.animations.stop();
					}

				//Checks to see if the spacebar is down
				if (fireButton.isDown) {

					socket.emit('fire', 1);
				}

				if (mouse.isDown) {
					console.log("Mouse X: " + mouse.x + " Y: " + mouse.y);
				}
			}

			/*Our custom code to handle game events */

			function spawnPlayer(playerColor) {

				/*Create player sprites based on color.  Sets start location, sprite, adds shield and sets respawn location on the event of death*/
				switch (playerColor) {
					case "blue":
					player = game.add.sprite(400, 580, 'prisoner_blue');
					playerShield = game.add.sprite(-30, -25, 'shield_blue');
					player.data.respawnX = 400;
					player.data.respawnY = 580;
					break;
					case "red":
					player = game.add.sprite(400, 20, 'prisoner_red');
					playerShield = game.add.sprite(-30, -25, 'shield_red');
					console.log(player);
					player.data.respawnX = 400;
					player.data.respawnY = 20;
					break;
					case "yellow":
					player = game.add.sprite(780, 300, 'prisoner_yellow');
					playerShield = game.add.sprite(-30, -25, 'shield_yellow');
					player.data.respawnX = 780, player.data.respawnY = 300;
					break;
					case "green":
					player = game.add.sprite(20, 300, 'prisoner_green');
					playerShield = game.add.sprite(-30, -25, 'shield_green');
					player.data.respawnX = 20, player.data.respawnY = 300;
					break;
				}

				//Enable physics on the player
				game.physics.arcade.enable(player);
				//set Circular hitbox centered on player's head
				player.body.isCircle = true;
				player.body.setCircle(15, 5, 5);
				//Stop player and pillars from leaving map.
				player.body.collideWorldBounds = true;
				//Make the player walk
				player.animations.add('walk', [0, 1, 2, 3], 5, true);
				//Set the center of the head as the rotation axis
				player.anchor.setTo(0.5, 0.5);
				console.log(player);

				//Create the player's shield, add animation for walking and make the shield a child of the player
				game.physics.arcade.enable(playerShield);
				playerShield.body.immovable = true;
				playerShield.animations.add('swingShield', [0, 1, 2, 3], 5, true);

				//Create the player's basic weapon, add animation for walking and make it a child of player
				playerGun = game.add.sprite(10, -23, 'gun_basic');
				playerGun.animations.add('swingGun', [0, 1, 2, 3], 5, true);
				playerGun.animations.add('fireGun', [0, 1, 2], 10, false);
				//Adds the newly created player and his shield to the players group
				console.log(player);
				playerShields.push(playerShield);
				//Add all children of the player
				player.addChild(playerShield);
				player.addChild(playerGun);

				return player;
			};

			function respawnPlayer(player) {
				player.reset(player.data.respawnX, player.data.respawnY);
			};

			function killPlayer(player, bullet) {
				player.kill();
				bullet.kill();
				//Respawn after 5 seconds
				setTimeout(respawnPlayer, 5000, player);
			}

			/*Player movement routines */

			function playerMove(msg) {
				switch (msg) {
						case 0: //north
						playerMoveN();
						break;
						case 1: //Northeast
						playerMoveNE();
						break;
						case 2: //East
						playerMoveE();
						break;
						case 3: //Southeast
						playerMoveSE();
						break;
						case 4: //South
						playerMoveS();
						break;
						case 5: //Southwest
						playerMoveSW();
						break;
						case 6: //West
						playerMoveW();
						break;
						case 7: //Northwest
						playerMoveNW();
						break;
						default:
						console.log("playerMove() error!");
					};

				};

				function playerMoveN() {
					player.body.velocity.y = -150;
					player.animations.play('walk');
					playerShield.animations.play('swingShield');
					playerGun.animations.play('swingGun');
					player.angle = 0;
					playerShield.body.setSize(32, 15, 0, -5);
					gun.fireAngle = Phaser.ANGLE_UP;
					gun.trackSprite(player, 15, -19);
				}

				function playerMoveNE() {
					player.body.velocity.x = 150;
					player.body.velocity.y = -150;
					player.animations.play('walk');
					playerShield.animations.play('swingShield');
					playerGun.animations.play('swingGun');
				}

				function playerMoveE() {
					player.body.velocity.x = 150;
					player.animations.play('walk');
					playerShield.animations.play('swingShield');
					playerGun.animations.play('swingGun');
					player.angle = 90;
					playerShield.body.setSize(15, 32, -15, 0);
					gun.fireAngle = Phaser.ANGLE_RIGHT;
					gun.trackSprite(player, 19, 15);
				}

				function playerMoveSE() {
					player.body.velocity.x = 150;
					player.body.velocity.y = 150;
					player.animations.play('walk');
					playerShield.animations.play('swingShield');
					playerGun.animations.play('swingGun');
				}

				function playerMoveS() {
					player.body.velocity.y = 150;
					player.animations.play('walk');
					playerShield.animations.play('swingShield');
					playerGun.animations.play('swingGun');
					player.angle = 180;
					playerShield.body.setSize(32, 15, -32, -15);
					gun.fireAngle = Phaser.ANGLE_DOWN;
					gun.trackSprite(player, -15, 19);
				}

				function playerMoveSW() {
					player.body.velocity.x = -150;
					player.body.velocity.y = 150;
					player.animations.play('walk');
					playerShield.animations.play('swing');
					playerGun.animations.play('swingGun');
				}

				function playerMoveW() {
					player.body.velocity.x = -150;
					player.animations.play('walk');
					playerShield.animations.play('swingShield');
					playerGun.animations.play('swingGun');
					player.angle = -90;
					playerShield.body.setSize(15, 32, 0, -32);
					gun.fireAngle = Phaser.ANGLE_LEFT;
					gun.trackSprite(player, -19, -15);

				}

				function playerMoveNW() {
					player.body.velocity.x = -150;
					player.body.velocity.y = -150;
					player.animations.play('walk');
					playerShield.animations.play('swingShield');
					playerGun.animations.play('swingGun');
				}

		//Networking Stuff
		$(document).ready(function() {
				//Establish network connection
				socket = io('http://192.168.2.7:3000');
				//Did we receive a 'fire' message from the server?
				socket.on('fire', function(msg) {
					if (msg === 1) gun.fire();
				});

				socket.on('move', function(msg) {
					playerMove(msg);
				});
			});

		</script>

	</body>

	</html>